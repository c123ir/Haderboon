# پرامپت توسعه سیستم احراز هویت در بک‌اند

این پرامپت برای توسعه سیستم احراز هویت در بک‌اند پروژه ایجنت هادربون طراحی شده است. این پرامپت را می‌توانید مستقیماً در ابزار کدنویسی هوش مصنوعی (مانند Cursor AI) استفاده کنید.

## پرامپت کامل

```
پروژه: ایجنت هادربون (بک‌اند Node.js/Express با TypeScript و Prisma ORM)

هدف: پیاده‌سازی سیستم احراز هویت کامل شامل ثبت‌نام، ورود، و محافظت از مسیرها.

زمینه: این یک پروژه مستندساز هوشمند مبتنی بر هوش مصنوعی است که به برنامه‌نویسان در مستندسازی پروژه‌ها کمک می‌کند.

# مدل داده کاربر در Prisma:

```prisma
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String   // پسورد هش شده
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // ارتباطات
  projects      Project[]
  conversations Conversation[]
}
```

## ۱. فایل‌های مورد نیاز:
1. `src/controllers/authController.ts`: کنترلر احراز هویت (ثبت‌نام، ورود، دریافت کاربر فعلی)
2. `src/middleware/authMiddleware.ts`: میدل‌ویر محافظت از مسیرها
3. `src/routes/authRoutes.ts`: مسیرهای API احراز هویت
4. `src/utils/jwtUtils.ts`: توابع کمکی برای کار با JWT
5. `src/utils/passwordUtils.ts`: توابع کمکی برای هش کردن و مقایسه پسورد

## ۲. وابستگی‌های مورد نیاز:
- bcryptjs: برای هش کردن پسورد
- jsonwebtoken: برای تولید و اعتبارسنجی توکن‌های JWT
- express: برای مدیریت درخواست‌های HTTP
- prisma: برای ارتباط با پایگاه داده

## ۳. جزئیات پیاده‌سازی:

### ۳.۱. `src/utils/passwordUtils.ts`:
این فایل باید شامل دو تابع اصلی باشد:
- `hashPassword`: برای هش کردن پسورد خام با استفاده از bcryptjs (با salt rounds 10)
- `comparePassword`: برای مقایسه پسورد خام با پسورد هش شده

### ۳.۲. `src/utils/jwtUtils.ts`:
این فایل باید شامل دو تابع اصلی باشد:
- `generateToken`: برای تولید JWT با استفاده از شناسه کاربر (userId)
- `verifyToken`: برای اعتبارسنجی و استخراج اطلاعات از JWT

### ۳.۳. `src/controllers/authController.ts`:
این فایل باید شامل سه تابع اصلی باشد:
- `registerUser`: برای ثبت‌نام کاربر جدید (دریافت email، username و password، هش کردن پسورد، ذخیره در دیتابیس، تولید JWT)
- `loginUser`: برای ورود کاربر (دریافت email/username و password، اعتبارسنجی، تولید JWT)
- `getCurrentUser`: برای دریافت اطلاعات کاربر فعلی بر اساس توکن JWT

### ۳.۴. `src/middleware/authMiddleware.ts`:
این فایل باید یک میدل‌ویر `protect` را پیاده‌سازی کند که:
- توکن JWT را از هدر `Authorization` استخراج کند
- با استفاده از `verifyToken` اعتبار توکن را بررسی کند
- کاربر مربوط به توکن را از دیتابیس بازیابی کند
- اطلاعات کاربر را به شیء `req` اضافه کند تا در کنترلرهای بعدی قابل دسترسی باشد

### ۳.۵. `src/routes/authRoutes.ts`:
این فایل باید مسیرهای زیر را تعریف کند:
- `POST /api/v1/auth/register`: برای ثبت‌نام کاربر جدید
- `POST /api/v1/auth/login`: برای ورود کاربر
- `GET /api/v1/auth/me`: برای دریافت اطلاعات کاربر فعلی (محافظت شده با میدل‌ویر `protect`)

## ۴. نکات مهم:
- تمام پاسخ‌ها باید در قالب JSON و با ساختار یکسان باشند
- خطاها باید به درستی مدیریت و به کاربر نمایش داده شوند
- اطلاعات حساس مانند پسورد هش شده نباید در پاسخ‌ها ارسال شوند
- توکن JWT باید تاریخ انقضا (مثلاً 7 روز) داشته باشد
- کدها باید تمیز، خوانا و با کامنت‌های فارسی توضیح داده شوند
- از تایپ‌های TypeScript برای افزایش ایمنی و خوانایی کد استفاده شود

## ۵. تایپ‌های مورد نیاز:

```typescript
// تایپ برای درخواست ثبت‌نام
interface RegisterUserRequest {
  username: string;
  email: string;
  password: string;
  firstName?: string;
  lastName?: string;
}

// تایپ برای درخواست ورود
interface LoginUserRequest {
  email: string;
  password: string;
}

// تایپ برای پاسخ احراز هویت
interface AuthResponse {
  success: boolean;
  token?: string;
  user?: {
    id: string;
    username: string;
    email: string;
    firstName?: string;
    lastName?: string;
  };
  message?: string;
}
```

لطفاً کدها را با رعایت استانداردهای TypeScript، با تایپ‌های دقیق، و با مدیریت مناسب خطاها پیاده‌سازی کنید.
```

## نمونه خروجی مورد انتظار

پس از استفاده از این پرامپت، انتظار داریم که هوش مصنوعی فایل‌های زیر را تولید کند:

### ۱. `src/utils/passwordUtils.ts`

```typescript
/**
 * @file src/utils/passwordUtils.ts
 * @description توابع کمکی برای هش کردن و مقایسه پسورد
 */

import bcrypt from 'bcryptjs';

/**
 * هش کردن پسورد با استفاده از bcryptjs
 * @param password پسورد خام
 * @returns پسورد هش شده
 */
export const hashPassword = async (password: string): Promise<string> => {
  const salt = await bcrypt.genSalt(10);
  return bcrypt.hash(password, salt);
};

/**
 * مقایسه پسورد خام با پسورد هش شده
 * @param password پسورد خام
 * @param hashedPassword پسورد هش شده
 * @returns نتیجه مقایسه (true/false)
 */
export const comparePassword = async (
  password: string,
  hashedPassword: string
): Promise<boolean> => {
  return bcrypt.compare(password, hashedPassword);
};
```

### ۲. `src/utils/jwtUtils.ts`

```typescript
/**
 * @file src/utils/jwtUtils.ts
 * @description توابع کمکی برای کار با JWT
 */

import jwt from 'jsonwebtoken';

// کلید رمزنگاری JWT از متغیرهای محیطی
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d';

/**
 * تولید توکن JWT بر اساس شناسه کاربر
 * @param userId شناسه کاربر
 * @returns توکن JWT
 */
export const generateToken = (userId: string): string => {
  return jwt.sign({ userId }, JWT_SECRET, {
    expiresIn: JWT_EXPIRES_IN,
  });
};

/**
 * اعتبارسنجی و استخراج اطلاعات از توکن JWT
 * @param token توکن JWT
 * @returns اطلاعات استخراج شده از توکن
 */
export const verifyToken = (token: string): { userId: string } => {
  try {
    const decoded = jwt.verify(token, JWT_SECRET) as { userId: string };
    return decoded;
  } catch (error) {
    throw new Error('توکن نامعتبر است');
  }
};
```

### ۳. `src/controllers/authController.ts`

```typescript
/**
 * @file src/controllers/authController.ts
 * @description کنترلر احراز هویت (ثبت‌نام، ورود، دریافت کاربر فعلی)
 */

import { Request, Response } from 'express';
import { PrismaClient } from '@prisma/client';
import { hashPassword, comparePassword } from '../utils/passwordUtils';
import { generateToken } from '../utils/jwtUtils';

// ایجاد نمونه Prisma Client
const prisma = new PrismaClient();

/**
 * ثبت‌نام کاربر جدید
 * @route POST /api/v1/auth/register
 */
export const registerUser = async (req: Request, res: Response) => {
  try {
    const { username, email, password, firstName, lastName } = req.body;

    // بررسی وجود کاربر با ایمیل یا نام کاربری مشابه
    const existingUser = await prisma.user.findFirst({
      where: {
        OR: [{ email }, { username }],
      },
    });

    if (existingUser) {
      return res.status(400).json({
        success: false,
        message: 'کاربر با این ایمیل یا نام کاربری قبلاً ثبت‌نام کرده است',
      });
    }

    // هش کردن پسورد
    const hashedPassword = await hashPassword(password);

    // ایجاد کاربر جدید
    const newUser = await prisma.user.create({
      data: {
        username,
        email,
        password: hashedPassword,
        firstName,
        lastName,
      },
    });

    // تولید توکن JWT
    const token = generateToken(newUser.id);

    // ارسال پاسخ موفقیت‌آمیز
    return res.status(201).json({
      success: true,
      token,
      user: {
        id: newUser.id,
        username: newUser.username,
        email: newUser.email,
        firstName: newUser.firstName,
        lastName: newUser.lastName,
      },
      message: 'ثبت‌نام با موفقیت انجام شد',
    });
  } catch (error) {
    console.error('خطا در ثبت‌نام:', error);
    return res.status(500).json({
      success: false,
      message: 'خطای سرور در ثبت‌نام کاربر',
    });
  }
};

/**
 * ورود کاربر
 * @route POST /api/v1/auth/login
 */
export const loginUser = async (req: Request, res: Response) => {
  try {
    const { email, password } = req.body;

    // یافتن کاربر بر اساس ایمیل
    const user = await prisma.user.findUnique({
      where: { email },
    });

    // بررسی وجود کاربر و صحت پسورد
    if (!user || !(await comparePassword(password, user.password))) {
      return res.status(401).json({
        success: false,
        message: 'ایمیل یا رمز عبور اشتباه است',
      });
    }

    // تولید توکن JWT
    const token = generateToken(user.id);

    // ارسال پاسخ موفقیت‌آمیز
    return res.status(200).json({
      success: true,
      token,
      user: {
        id: user.id,
        username: user.username,
        email: user.email,
        firstName: user.firstName,
        lastName: user.lastName,
      },
      message: 'ورود با موفقیت انجام شد',
    });
  } catch (error) {
    console.error('خطا در ورود:', error);
    return res.status(500).json({
      success: false,
      message: 'خطای سرور در ورود کاربر',
    });
  }
};

/**
 * دریافت اطلاعات کاربر فعلی
 * @route GET /api/v1/auth/me
 */
export const getCurrentUser = async (req: Request, res: Response) => {
  try {
    // دریافت شناسه کاربر از req.user (تنظیم شده توسط میدل‌ویر protect)
    const userId = req.user?.id;

    if (!userId) {
      return res.status(401).json({
        success: false,
        message: 'لطفاً ابتدا وارد شوید',
      });
    }

    // دریافت اطلاعات کاربر از دیتابیس
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: {
        id: true,
        username: true,
        email: true,
        firstName: true,
        lastName: true,
        createdAt: true,
        updatedAt: true,
      },
    });

    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'کاربر یافت نشد',
      });
    }

    // ارسال اطلاعات کاربر
    return res.status(200).json({
      success: true,
      user,
    });
  } catch (error) {
    console.error('خطا در دریافت اطلاعات کاربر:', error);
    return res.status(500).json({
      success: false,
      message: 'خطای سرور در دریافت اطلاعات کاربر',
    });
  }
};
```

### ۴. `src/middleware/authMiddleware.ts`

```typescript
/**
 * @file src/middleware/authMiddleware.ts
 * @description میدل‌ویر محافظت از مسیرها
 */

import { Request, Response, NextFunction } from 'express';
import { PrismaClient } from '@prisma/client';
import { verifyToken } from '../utils/jwtUtils';

// ایجاد نمونه Prisma Client
const prisma = new PrismaClient();

// افزودن یک پراپرتی جدید به تایپ Request برای ذخیره اطلاعات کاربر
declare global {
  namespace Express {
    interface Request {
      user?: { id: string };
    }
  }
}

/**
 * میدل‌ویر محافظت از مسیرها
 * توکن JWT را از هدر Authorization استخراج و اعتبارسنجی می‌کند
 */
export const protect = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    let token;

    // بررسی وجود توکن در هدر
    if (
      req.headers.authorization &&
      req.headers.authorization.startsWith('Bearer')
    ) {
      // استخراج توکن از هدر Authorization
      token = req.headers.authorization.split(' ')[1];
    }

    // اگر توکن وجود نداشت، خطا برگردان
    if (!token) {
      return res.status(401).json({
        success: false,
        message: 'لطفاً برای دسترسی به این بخش ابتدا وارد شوید',
      });
    }

    try {
      // اعتبارسنجی توکن
      const decoded = verifyToken(token);

      // بررسی وجود کاربر
      const user = await prisma.user.findUnique({
        where: { id: decoded.userId },
      });

      if (!user) {
        return res.status(401).json({
          success: false,
          message: 'کاربر یافت نشد',
        });
      }

      // افزودن اطلاعات کاربر به درخواست
      req.user = { id: user.id };

      // ادامه پردازش درخواست
      next();
    } catch (error) {
      return res.status(401).json({
        success: false,
        message: 'توکن نامعتبر است یا منقضی شده است',
      });
    }
  } catch (error) {
    console.error('خطا در میدل‌ویر احراز هویت:', error);
    return res.status(500).json({
      success: false,
      message: 'خطای سرور در احراز هویت',
    });
  }
};
```

### ۵. `src/routes/authRoutes.ts`

```typescript
/**
 * @file src/routes/authRoutes.ts
 * @description مسیرهای API احراز هویت
 */

import express from 'express';
import {
  registerUser,
  loginUser,
  getCurrentUser,
} from '../controllers/authController';
import { protect } from '../middleware/authMiddleware';

const router = express.Router();

// مسیر ثبت‌نام کاربر جدید
router.post('/register', registerUser);

// مسیر ورود کاربر
router.post('/login', loginUser);

// مسیر دریافت اطلاعات کاربر فعلی (محافظت شده)
router.get('/me', protect, getCurrentUser);

export default router;
```

## نحوه استفاده از پرامپت

1. کل محتوای بخش "پرامپت کامل" را کپی کنید.
2. آن را در ابزار کدنویسی هوش مصنوعی مانند Cursor AI قرار دهید.
3. از هوش مصنوعی بخواهید که کدهای مورد نیاز را بر اساس پرامپت تولید کند.
4. کدهای تولید شده را در فایل‌های مربوطه در پروژه خود ذخیره کنید.
5. وابستگی‌های مورد نیاز را نصب کنید:
   ```bash
   npm install bcryptjs jsonwebtoken
   npm install --save-dev @types/bcryptjs @types/jsonwebtoken
   ``` 