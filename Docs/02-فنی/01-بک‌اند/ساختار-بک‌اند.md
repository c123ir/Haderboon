# ساختار بک‌اند ایجنت هادربون

## ۱. ساختار پوشه‌ها و فایل‌ها

```
backend/
├── prisma/                   # تنظیمات و مدل‌های Prisma
│   ├── schema.prisma         # تعریف مدل‌های پایگاه داده
│   └── migrations/           # میگریشن‌های پایگاه داده
├── src/                      # کدهای اصلی بک‌اند
│   ├── controllers/          # کنترلرهای API
│   │   ├── authController.ts # کنترلرهای مربوط به احراز هویت
│   │   ├── projectController.ts # کنترلرهای مربوط به پروژه
│   │   ├── documentController.ts # کنترلرهای مربوط به مستندات
│   │   └── chatController.ts # کنترلرهای مربوط به چت
│   ├── middleware/           # میدل‌ویرهای Express
│   │   ├── authMiddleware.ts # میدل‌ویر احراز هویت
│   │   ├── errorMiddleware.ts # میدل‌ویر مدیریت خطا
│   │   └── uploadMiddleware.ts # میدل‌ویر آپلود فایل
│   ├── routes/               # مسیرهای API
│   │   ├── authRoutes.ts     # مسیرهای مربوط به احراز هویت
│   │   ├── projectRoutes.ts  # مسیرهای مربوط به پروژه
│   │   ├── documentRoutes.ts # مسیرهای مربوط به مستندات
│   │   └── chatRoutes.ts     # مسیرهای مربوط به چت
│   ├── services/             # سرویس‌های منطق کسب‌وکار
│   │   ├── aiService.ts      # سرویس ارتباط با هوش مصنوعی
│   │   ├── codeAnalysisService.ts # سرویس تحلیل کد
│   │   └── documentationService.ts # سرویس تولید مستندات
│   ├── utils/                # توابع و ابزارهای کمکی
│   │   ├── prismaClient.ts   # اتصال به Prisma
│   │   ├── jwtUtils.ts       # توابع کار با JWT
│   │   ├── passwordUtils.ts  # توابع مدیریت رمز عبور
│   │   └── logger.ts         # سیستم لاگینگ
│   ├── types/                # تعاریف تایپ‌های TypeScript
│   │   ├── index.ts          # صادرات همه تایپ‌ها
│   │   ├── auth.types.ts     # تایپ‌های مربوط به احراز هویت
│   │   ├── project.types.ts  # تایپ‌های مربوط به پروژه
│   │   └── ai.types.ts       # تایپ‌های مربوط به هوش مصنوعی
│   ├── config/               # تنظیمات برنامه
│   │   ├── env.ts            # دسترسی به متغیرهای محیطی
│   │   └── corsConfig.ts     # تنظیمات CORS
│   └── server.ts             # نقطه ورود اصلی برنامه
├── .env                      # متغیرهای محیطی
├── .env.example              # نمونه متغیرهای محیطی
├── package.json              # وابستگی‌ها و اسکریپت‌ها
├── tsconfig.json             # تنظیمات TypeScript
└── README.md                 # مستندات راه‌اندازی و استفاده
```

## ۲. مدل‌های پایگاه داده (Prisma Schema)

فایل `schema.prisma` شامل تعریف تمام مدل‌های پایگاه داده پروژه است. در ادامه به تعریف مدل‌های اصلی می‌پردازیم.

### ۲.۱. مدل کاربر (User)

```prisma
model User {
  id             String    @id @default(uuid())
  email          String    @unique
  username       String    @unique
  password       String    // پسورد هش شده
  firstName      String?
  lastName       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // ارتباطات
  projects       Project[]
  conversations  Conversation[]
}
```

### ۲.۲. مدل پروژه (Project)

```prisma
model Project {
  id          String    @id @default(uuid())
  name        String
  description String?
  ownerId     String
  owner       User      @relation(fields: [ownerId], references: [id])
  path        String?   // مسیر پروژه (اختیاری)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // ارتباطات
  documents      Document[]
  conversations  Conversation[]
  files          File[]
}
```

### ۲.۳. مدل مستند (Document)

```prisma
model Document {
  id          String   @id @default(uuid())
  title       String
  content     Json     // محتوای ساختاریافته (JSON)
  type        String   // نوع مستند (مثلاً CODE_ANALYSIS, DESIGN_DECISION, etc.)
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

### ۲.۴. مدل‌های مربوط به چت

```prisma
model Conversation {
  id          String    @id @default(uuid())
  title       String?
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id])
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // ارتباطات
  messages    Message[]
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         String       // USER یا AI
  contentType    String       // TEXT یا IMAGE
  content        Json         // محتوای پیام (متن یا URL)
  createdAt      DateTime     @default(now())
}
```

### ۲.۵. مدل فایل (File)

```prisma
model File {
  id          String   @id @default(uuid())
  name        String
  path        String   // مسیر ذخیره‌سازی فایل
  mimeType    String
  size        Int
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  uploadedBy  String   // شناسه کاربر آپلود‌کننده
  createdAt   DateTime @default(now())
}
```

## ۳. معماری کنترلرها و مسیرها

### ۳.۱. کنترلر احراز هویت (Authentication Controller)

```typescript
// src/controllers/authController.ts
import { Request, Response } from 'express';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import prisma from '../utils/prismaClient';

// تابع ثبت‌نام کاربر
export const registerUser = async (req: Request, res: Response) => {
  try {
    const { username, email, password } = req.body;
    
    // بررسی وجود کاربر
    const existingUser = await prisma.user.findFirst({
      where: { OR: [{ email }, { username }] }
    });
    
    if (existingUser) {
      return res.status(400).json({
        success: false,
        message: 'کاربر با این ایمیل یا نام کاربری قبلاً ثبت‌نام کرده است'
      });
    }
    
    // هش کردن پسورد
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(password, salt);
    
    // ایجاد کاربر جدید
    const newUser = await prisma.user.create({
      data: { username, email, password: hashedPassword }
    });
    
    // تولید JWT
    const token = jwt.sign(
      { userId: newUser.id },
      process.env.JWT_SECRET || 'your-secret-key',
      { expiresIn: '7d' }
    );
    
    return res.status(201).json({
      success: true,
      token,
      user: {
        id: newUser.id,
        username: newUser.username,
        email: newUser.email
      }
    });
  } catch (error) {
    console.error('خطا در ثبت‌نام:', error);
    return res.status(500).json({
      success: false,
      message: 'خطای سرور در ثبت‌نام کاربر'
    });
  }
};

// تابع ورود کاربر
export const loginUser = async (req: Request, res: Response) => {
  // پیاده‌سازی مشابه
};
```

### ۳.۲. مسیرهای API (Routes)

```typescript
// src/routes/authRoutes.ts
import express from 'express';
import { registerUser, loginUser } from '../controllers/authController';

const router = express.Router();

// مسیرهای احراز هویت
router.post('/register', registerUser);
router.post('/login', loginUser);

export default router;
```

```typescript
// src/server.ts
import express from 'express';
import dotenv from 'dotenv';
import cors from 'cors';
import authRoutes from './routes/authRoutes';
import projectRoutes from './routes/projectRoutes';
import documentRoutes from './routes/documentRoutes';
import chatRoutes from './routes/chatRoutes';
import { errorHandler } from './middleware/errorMiddleware';

// بارگذاری متغیرهای محیطی
dotenv.config();

const app = express();
const PORT = process.env.BACKEND_PORT || 5550;

// میدل‌ویرها
app.use(cors());
app.use(express.json());

// مسیرها
app.use('/api/v1/auth', authRoutes);
app.use('/api/v1/projects', projectRoutes);
app.use('/api/v1/documents', documentRoutes);
app.use('/api/v1/chat', chatRoutes);

// میدل‌ویر مدیریت خطا
app.use(errorHandler);

// راه‌اندازی سرور
app.listen(PORT, () => {
  console.log(`سرور بک‌اند ایجنت هادربون بر روی پورت ${PORT} در حال گوش دادن است.`);
});
```

## ۴. میدل‌ویرهای کلیدی

### ۴.۱. میدل‌ویر احراز هویت

```typescript
// src/middleware/authMiddleware.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import prisma from '../utils/prismaClient';

// افزودن یک پراپرتی جدید به تایپ Request برای ذخیره اطلاعات کاربر
declare global {
  namespace Express {
    interface Request {
      user?: { id: string };
    }
  }
}

export const protect = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    let token;
    
    // بررسی وجود توکن در هدر
    if (
      req.headers.authorization &&
      req.headers.authorization.startsWith('Bearer')
    ) {
      token = req.headers.authorization.split(' ')[1];
    }
    
    if (!token) {
      return res.status(401).json({
        success: false,
        message: 'دسترسی غیرمجاز: توکن احراز هویت یافت نشد'
      });
    }
    
    try {
      // اعتبارسنجی توکن
      const decoded = jwt.verify(
        token,
        process.env.JWT_SECRET || 'your-secret-key'
      ) as { userId: string };
      
      // بررسی وجود کاربر
      const user = await prisma.user.findUnique({
        where: { id: decoded.userId }
      });
      
      if (!user) {
        return res.status(401).json({
          success: false,
          message: 'دسترسی غیرمجاز: کاربر یافت نشد'
        });
      }
      
      // افزودن اطلاعات کاربر به درخواست
      req.user = { id: user.id };
      next();
    } catch (error) {
      return res.status(401).json({
        success: false,
        message: 'دسترسی غیرمجاز: توکن نامعتبر'
      });
    }
  } catch (error) {
    console.error('خطا در میدل‌ویر احراز هویت:', error);
    return res.status(500).json({
      success: false,
      message: 'خطای سرور در احراز هویت'
    });
  }
};
```

## ۵. سرویس‌های کلیدی

### ۵.۱. سرویس هوش مصنوعی

```typescript
// src/services/aiService.ts
import axios from 'axios';
import { AIRequest, AIResponse } from '../types/ai.types';

// سرویس ارتباط با هوش مصنوعی
export class AIService {
  private apiKey: string;
  private baseUrl: string;
  
  constructor() {
    this.apiKey = process.env.AI_API_KEY || '';
    this.baseUrl = process.env.AI_API_BASE_URL || '';
  }
  
  // فراخوانی مدل زبانی (متن به متن)
  async generateTextResponse(prompt: string, context: string[]): Promise<string> {
    try {
      const response = await axios.post(
        `${this.baseUrl}/generate`,
        {
          prompt,
          context,
          max_tokens: 2000,
          temperature: 0.7,
        },
        {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
          }
        }
      );
      
      return response.data.text;
    } catch (error) {
      console.error('خطا در فراخوانی AI:', error);
      throw new Error('خطا در ارتباط با سرویس هوش مصنوعی');
    }
  }
  
  // فراخوانی مدل چندوجهی (تصویر و متن)
  async analyzeImage(imageUrl: string, prompt: string): Promise<string> {
    try {
      const response = await axios.post(
        `${this.baseUrl}/analyze-image`,
        {
          image_url: imageUrl,
          prompt,
        },
        {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.apiKey}`
          }
        }
      );
      
      return response.data.analysis;
    } catch (error) {
      console.error('خطا در تحلیل تصویر:', error);
      throw new Error('خطا در تحلیل تصویر توسط هوش مصنوعی');
    }
  }
}

export default new AIService();
```

## ۶. فایل .env

نمونه فایل `.env` برای بک‌اند:

```
# پورت بک‌اند
BACKEND_PORT=5550

# اتصال به پایگاه داده
DATABASE_URL="postgresql://haderboon_user:2123@localhost:5432/haderboon_db?schema=public"

# کلید رمزنگاری JWT
JWT_SECRET=your-secure-jwt-secret-key-here
JWT_EXPIRES_IN=7d

# کلید API هوش مصنوعی (مثال: Gemini Pro)
AI_API_KEY=your-gemini-api-key
AI_API_BASE_URL=https://generativelanguage.googleapis.com/v1

# OpenRouter (برای دسترسی به مدل‌های مختلف)
OPENROUTER_API_KEY=your-openrouter-api-key
OPENROUTER_API_BASE_URL=https://openrouter.ai/api/v1

# تنظیمات آپلود فایل
UPLOAD_DIR=uploads
MAX_FILE_SIZE=10485760 # 10MB
``` 