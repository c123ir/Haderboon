# معماری سیستم ایجنت هوشمند

## مقدمه

ایجنت هوشمند هادربون یک سیستم یکپارچه برای استفاده از قابلیت‌های هوش مصنوعی مختلف در پروژه است. این سیستم امکان اتصال به چندین سرویس‌دهنده هوش مصنوعی را فراهم می‌کند و قابلیت‌های مختلفی مانند چت، تولید متن، پردازش تصویر و غیره را ارائه می‌دهد.

## اهداف طراحی

- **انعطاف‌پذیری**: امکان اتصال به سرویس‌دهنده‌های مختلف
- **مقیاس‌پذیری**: قابلیت توسعه و اضافه کردن قابلیت‌های جدید
- **امنیت**: ذخیره‌سازی امن کلیدهای API
- **یکپارچگی**: رابط برنامه‌نویسی (API) واحد برای تمام سرویس‌ها
- **مدیریت**: امکان مدیریت و نظارت بر استفاده از سرویس‌ها

## معماری کلی

سیستم ایجنت هوشمند از الگوی طراحی Adapter استفاده می‌کند. این الگو امکان استفاده از چندین سرویس‌دهنده مختلف را با یک رابط یکسان فراهم می‌کند.

```Haderboon/Docs/02-فنی/04-ایجنت-هوشمند/01-معماری-سیستم.md
<code_block_to_apply_changes_from>
                                 ┌─────────────────┐
                                 │  Client (Web/App) │
                                 └─────────┬─────────┘
                                           │
                                           ▼
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                              Backend                                   │
│                                                                        │
│   ┌────────────┐        ┌─────────────┐         ┌─────────────────┐   │
│   │  AIService  │◄──────┤ Controllers │◄────────┤     Routes      │   │
│   └──────┬─────┘        └─────────────┘         └─────────────────┘   │
│          │                                                             │
│          ▼                                                             │
│  ┌───────────────────┐                                                 │
│  │ AIProviderFactory │                                                 │
│  └─────────┬─────────┘                                                 │
│            │                                                           │
│            ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                        IAIProvider Interface                     │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│            │                                                           │
│            ├─────────────┬───────────────┬──────────────┬──────────┐  │
│            ▼             ▼               ▼              ▼          ▼  │
│   ┌───────────────┐ ┌──────────────┐ ┌────────────┐ ┌──────────┐ ┌───┐ │
│   │ OpenAIAdapter │ │ GoogleAdapter │ │ ClaudeAdapter │ │ GrokAdapter │ │...│ │
│   └───────┬───────┘ └───────┬──────┘ └──────┬─────┘ └─────┬────┘ └───┘ │
│           │                 │               │             │            │
└───────────┼─────────────────┼───────────────┼─────────────┼────────────┘
            │                 │               │             │
            ▼                 ▼               ▼             ▼
      ┌──────────┐      ┌──────────┐     ┌──────────┐   ┌──────────┐
      │  OpenAI  │      │ Google AI │     │ Anthropic │   │  Grok AI  │
      └──────────┘      └──────────┘     └──────────┘   └──────────┘
```

## اجزای اصلی

### 1. رابط برنامه‌نویسی (API Interface)

در مرکز معماری، یک رابط مشترک (`IAIProvider`) قرار دارد که تمام سرویس‌دهنده‌ها باید آن را پیاده‌سازی کنند. این رابط شامل متدهای اصلی مانند:

- `validateApiKey`: بررسی اعتبار کلید API
- `getAvailableModels`: دریافت لیست مدل‌های موجود
- `chat`: ارسال درخواست چت
- `getEmbedding`: دریافت بردارهای متنی (اختیاری)

### 2. Adapter‌ها

برای هر سرویس‌دهنده هوش مصنوعی، یک Adapter مجزا ایجاد شده است:

- `OpenAIProvider`: برای سرویس OpenAI
- `GoogleAIProvider`: برای سرویس Google AI (Gemini)
- `AnthropicProvider`: برای سرویس Anthropic (Claude)
- `OpenRouterProvider`: برای سرویس OpenRouter
- `GrokAIProvider`: برای سرویس Grok AI

هر Adapter وظیفه تبدیل درخواست‌های استاندارد به فرمت مخصوص سرویس‌دهنده مربوطه را دارد.

### 3. کارخانه (Factory)

کلاس `AIProviderFactory` مسئول ایجاد نمونه‌های مناسب از Adapter‌ها است. این کلاس با توجه به نام سرویس‌دهنده، Adapter مناسب را ایجاد می‌کند.

### 4. سرویس اصلی

کلاس `AIService` نقطه ورودی اصلی برای استفاده از قابلیت‌های هوش مصنوعی است. این سرویس:

- مدیریت کلیدهای API را انجام می‌دهد
- جلسات چت را مدیریت می‌کند
- پیام‌ها را ذخیره می‌کند
- آمار استفاده را ثبت می‌کند

### 5. سرویس رمزنگاری

کلاس `CryptoService` برای رمزگذاری و رمزگشایی کلیدهای API استفاده می‌شود تا از امنیت آن‌ها اطمینان حاصل شود.

## مدل داده

سیستم ایجنت هوشمند از چندین مدل داده استفاده می‌کند:

### 1. سرویس‌دهنده (AIProvider)

- **id**: شناسه منحصر به فرد
- **name**: نام سرویس‌دهنده (کلید)
- **displayName**: نام نمایشی
- **description**: توضیحات
- **logoUrl**: آدرس لوگو
- **baseUrl**: آدرس پایه API
- **isActive**: وضعیت فعال بودن
- **priority**: اولویت استفاده
- **settings**: تنظیمات اضافی

### 2. کلید API (AIApiKey)

- **id**: شناسه منحصر به فرد
- **providerId**: شناسه سرویس‌دهنده
- **name**: نام نمایشی کلید
- **key**: کلید API (رمزگذاری شده)
- **isActive**: وضعیت فعال بودن
- **expiresAt**: تاریخ انقضا
- **createdAt**: تاریخ ایجاد
- **updatedAt**: تاریخ به‌روزرسانی

### 3. مدل (AIModel)

- **id**: شناسه منحصر به فرد
- **providerId**: شناسه سرویس‌دهنده
- **name**: نام مدل (کلید)
- **displayName**: نام نمایشی
- **description**: توضیحات
- **capabilities**: قابلیت‌ها (chat, embedding, vision, ...)
- **contextSize**: حداکثر اندازه متن ورودی
- **isActive**: وضعیت فعال بودن
- **settings**: تنظیمات اضافی

### 4. جلسه (AISession)

- **id**: شناسه منحصر به فرد
- **title**: عنوان جلسه
- **userId**: شناسه کاربر
- **providerId**: شناسه سرویس‌دهنده
- **modelId**: شناسه مدل
- **systemPrompt**: پیام سیستمی
- **settings**: تنظیمات جلسه
- **createdAt**: تاریخ ایجاد
- **updatedAt**: تاریخ به‌روزرسانی

### 5. پیام (AIMessage)

- **id**: شناسه منحصر به فرد
- **sessionId**: شناسه جلسه
- **role**: نقش پیام (user, assistant, system)
- **content**: محتوای پیام
- **usage**: اطلاعات استفاده از توکن‌ها
- **createdAt**: تاریخ ایجاد

## API‌های عمومی

سیستم ایجنت هوشمند چندین مسیر API برای استفاده در برنامه ارائه می‌دهد:

- `GET /api/ai/providers`: دریافت لیست سرویس‌دهنده‌ها
- `GET /api/ai/api-keys`: دریافت لیست کلیدهای API (فقط مدیر)
- `POST /api/ai/api-keys`: ایجاد کلید API جدید (فقط مدیر)
- `PUT /api/ai/api-keys/:id`: به‌روزرسانی کلید API (فقط مدیر)
- `DELETE /api/ai/api-keys/:id`: حذف کلید API (فقط مدیر)
- `GET /api/ai/models`: دریافت لیست مدل‌ها
- `GET /api/ai/providers/:providerId/models`: دریافت مدل‌های موجود از API (فقط مدیر)
- `POST /api/ai/chat`: ارسال درخواست چت
- `GET /api/ai/sessions`: دریافت لیست جلسات چت
- `GET /api/ai/sessions/:sessionId/messages`: دریافت پیام‌های یک جلسه

## جریان کار

1. کاربر یک درخواست چت از طریق API ارسال می‌کند
2. `AIController` درخواست را دریافت می‌کند
3. درخواست به `AIService` ارسال می‌شود
4. `AIService` سرویس‌دهنده مناسب را انتخاب می‌کند
5. کلید API مربوطه از پایگاه داده دریافت و رمزگشایی می‌شود
6. `AIProviderFactory` Adapter مناسب را ایجاد می‌کند
7. درخواست به Adapter ارسال می‌شود
8. Adapter درخواست را به فرمت مناسب سرویس‌دهنده تبدیل می‌کند
9. درخواست به سرویس‌دهنده هوش مصنوعی (OpenAI, Google, ...) ارسال می‌شود
10. پاسخ دریافت و به فرمت استاندارد تبدیل می‌شود
11. پیام‌های کاربر و پاسخ در پایگاه داده ذخیره می‌شوند
12. پاسخ به کاربر برگردانده می‌شود

## امنیت

- کلیدهای API به صورت رمزگذاری شده در پایگاه داده ذخیره می‌شوند
- تنها کاربران مدیر به بخش مدیریت کلیدها دسترسی دارند
- هر کاربر فقط به جلسات خودش دسترسی دارد
- احراز هویت برای تمام مسیرهای API الزامی است

## توسعه‌پذیری

سیستم ایجنت هوشمند برای توسعه‌های آینده طراحی شده است:

- **افزودن سرویس‌دهنده جدید**: کافی است یک Adapter جدید ایجاد و به Factory اضافه شود
- **افزودن قابلیت جدید**: با اضافه کردن متدهای جدید به رابط `IAIProvider` و پیاده‌سازی آن در Adapter‌ها
- **پشتیبانی از مدل‌های جدید**: با به‌روزرسانی Adapter‌ها و اضافه کردن مدل‌های جدید به پایگاه داده

## نتیجه‌گیری

معماری سیستم ایجنت هوشمند هادربون با استفاده از الگوهای طراحی مناسب، یک سیستم انعطاف‌پذیر، امن و قابل توسعه را فراهم می‌کند که می‌تواند با سرویس‌دهنده‌های مختلف هوش مصنوعی کار کند و قابلیت‌های متنوعی را ارائه دهد. 